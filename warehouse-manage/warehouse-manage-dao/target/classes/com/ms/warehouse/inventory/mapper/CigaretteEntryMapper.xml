<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.ms.warehouse.inventory.mapper.CigaretteEntryMapper">

	<!-- 结果Map -->
	<resultMap id="BaseResultMap" type="com.ms.warehouse.inventory.entity.EntrymaterielEntity">
		<result property="id" jdbcType="INTEGER" column="f_id"/>
		<result property="dataId" jdbcType="VARCHAR" column="f_data_id"/>
		<result property="materCode" jdbcType="VARCHAR" column="f_mater_code"/>
		<result property="materName" jdbcType="VARCHAR" column="f_mater_name"/>
		<result property="versioncode" jdbcType="VARCHAR" column="f_ver_name"/>
		<result property="cigBrandName" jdbcType="VARCHAR" column="f_bra_name"/>
		<result property="subverName" jdbcType="VARCHAR" column="f_subver_name"/>
		<result property="subId" jdbcType="INTEGER" column="subId"/>
	</resultMap>
	
	<resultMap id="LocalResultMap" type="com.ms.warehouse.inventory.entity.EntrytraylocalmapEntity">
		<result property="id" jdbcType="INTEGER" column="f_id"/>
		<result property="localId" jdbcType="VARCHAR" column="f_id"/>
		<result property="localCode" jdbcType="VARCHAR" column="f_local_code"/>
		<result property="localRfid" jdbcType="VARCHAR" column="f_local_rfid"/>		
		<result property="descript" jdbcType="VARCHAR" column="f_descript"/>
	</resultMap>

	<resultMap id="localResultMap" type="com.ms.warehouse.inventory.entity.EntrytraylocalmapEntity">
		<result property="id" jdbcType="INTEGER" column="f_id"/>
		<result property="orderdetailId" jdbcType="INTEGER" column="f_orderdetail_id"/>
		<result property="cigsmokeQuality" jdbcType="DECIMAL" column="f_cigsmoke_quality"/>
		<result property="trayRfid" jdbcType="VARCHAR" column="f_tray_rfid"/>
		<result property="localId" jdbcType="INTEGER" column="f_local_id"/>
		<result property="localCode" jdbcType="VARCHAR" column="f_local_code"/>
		<result property="localRfid" jdbcType="VARCHAR" column="f_local_rfid"/>
		<result property="createdDate" jdbcType="TIMESTAMP" column="f_created_date"/>
		<result property="createdPersonId" jdbcType="INTEGER" column="f_created_person_id"/>
		<result property="createdPerson" jdbcType="VARCHAR" column="f_created_person"/>
		<result property="updatedDate" jdbcType="TIMESTAMP" column="f_updated_date"/>
		<result property="updatedPersonId" jdbcType="INTEGER" column="f_updated_person_id"/>
		<result property="updatedPerson" jdbcType="VARCHAR" column="f_updated_person"/>
		<result property="status" jdbcType="INTEGER" column="f_status"/>
		<result property="batchNo" jdbcType="VARCHAR" column="f_batch_no"/>
		<result property="soleCode" jdbcType="VARCHAR" column="f_sole_code"/>
		<result property="trayCode" jdbcType="VARCHAR" column="f_tray_code"/>
		<result property="wareMethod" jdbcType="INTEGER" column="f_ware_method"/>
	</resultMap>
	
	
	<resultMap id="EntryorderdetailResultMap" type="com.ms.warehouse.inventory.entity.EntryorderdetailEntity">
		<result property="id" jdbcType="INTEGER" column="f_id"/>
		<result property="mainorderId" jdbcType="INTEGER" column="f_mainorder_id"/>
		<result property="materCode" jdbcType="VARCHAR" column="f_mater_code"/>
		<result property="materName" jdbcType="VARCHAR" column="f_mater_name"/>
		<result property="quality" jdbcType="DECIMAL" column="f_quality"/>
		<result property="batchNo" jdbcType="VARCHAR" column="f_batch_no"/>
		<result property="materVersion" jdbcType="VARCHAR" column="f_mater_version"/>
		<result property="materCigbrand" jdbcType="VARCHAR" column="f_mater_cigbrand"/>
		<result property="actualQuality" jdbcType="DECIMAL" column="f_actual_quality"/>
		<result property="produceDate" jdbcType="TIMESTAMP" column="f_produce_date"/>
		<result property="cigtype" jdbcType="INTEGER" column="f_cigtype"/>
		<result property="subverId" jdbcType="INTEGER" column="f_subver_id"/>
		<result property="subverName" jdbcType="VARCHAR" column="f_subver_name"/>
		<result property="isDelete" jdbcType="TINYINT" column="f_is_delete"/>
		<result property="converCoef" jdbcType="DECIMAL" column="converCoef"/>
		<result property="name" jdbcType="VARCHAR" column="name"/>
		<result property="value" jdbcType="INTEGER" column="value"/>
	</resultMap>

	<!-- 查询列 -->
	<sql id="BaseColumnList">
		f_id,f_orderdetail_id,f_cigsmoke_quality,f_tray_rfid,f_local_id,f_local_code,f_local_rfid,f_created_date,f_created_person_id,f_created_person,f_updated_date,f_updated_person_id,f_updated_person,f_status,f_batch_no,f_sole_code,f_tray_code,f_ware_method
	</sql>
	
	<!-- 分页查询 -->
	<select id="queryByPage" parameterType="com.ms.warehouse.common.vo.ListVo.ListReqVO"
			resultMap="BaseResultMap">
 	 	 
 	 	 select *  from 	 	 	
		 ( 				
				SELECT tbm.f_id, tbm.f_mater_code, tbm.f_mater_name,tmc.f_bra_name,
				tmb.f_ver_name,tt.f_id as subId ,tt.f_subver_name, 0 as cigtype , CONCAT(tbm.f_mater_code,tt.f_id) AS codeid 
				FROM t_base_materialinfo tbm 
				LEFT  JOIN  t_mater_cigbrand tmc   ON tbm.f_cigbrand=tmc.f_data_id
				LEFT  JOIN  t_mater_cigversion tmb  ON  tbm.f_versioncode=tmb.f_data_id
        		LEFT  JOIN  t_base_matersubvermap  mm  on mm.f_mater_code = tbm.f_mater_code
        		LEFT  JOIN  t_base_subversion tt on mm.f_subver_id = tt.f_id
        		        		        	       																			
		 UNION ALL		
		 SELECT tbt.f_id, tbt.f_code, tbt.f_name,tmc.f_bra_name,
				tmb.f_ver_name,tt.f_id as subId ,tt.f_subver_name,
				1 as cigtype , CONCAT(tbt.f_code,tt.f_id) AS codeid
				FROM t_base_testcigarette tbt
				LEFT  JOIN  t_mater_cigbrand tmc   ON tbt.f_cigbrand=tmc.f_data_id
				LEFT  JOIN  t_mater_cigversion tmb  ON  tbt.`f_versioncode`=tmb.`f_data_id`	
				LEFT  JOIN  t_base_matersubvermap  mm  on mm.f_mater_code = tbt.f_code
        		LEFT  JOIN  t_base_subversion tt on mm.f_subver_id = tt.f_id				
		) a
				
 		<where>
			1=1
			<if test="whereCondition!=null">
				<if test="whereCondition.materCode!=null and whereCondition.materCode!=''">
				AND (a.f_mater_code like concat(concat('%',#{whereCondition.materCode,jdbcType=VARCHAR}),'%')  
				or a.f_mater_name like   concat(concat('%',#{whereCondition.materCode,jdbcType=VARCHAR}),'%'))
				</if>			  	
				<if test="whereCondition.cigtype!=null and whereCondition.cigtype!=''">AND a.cigtype = #{whereCondition.cigtype,jdbcType=INTEGER}</if>
				<if test="whereCondition.mainorderId!=null and whereCondition.mainorderId!=''">				
				AND a.codeid not in (SELECT CONCAT(twe.f_mater_code,twe.f_subver_id) AS codeid FROM t_ware_entryorderdetail twe 
				WHERE twe.f_mainorder_id = #{whereCondition.mainorderId,jdbcType=INTEGER} )				
				</if>								
			</if>	 						
		</where>		
		<choose>
			<when test="orderField==null">
				ORDER BY f_id DESC
			</when>
			<otherwise>
				ORDER BY ${orderField}
			</otherwise>
		</choose>
	</select>


	<!-- 查询记录数 -->
	<select id="queryCount" resultType="int"
			parameterType="com.ms.warehouse.common.vo.ListVo.ListReqVO">		
	 select COUNT(1)  from
 	 	 	
		 ( SELECT tbm.f_id, tbm.f_mater_code, tbm.f_mater_name,CONCAT(tmc.f_bra_name,'(',tmc.`f_bra_code`,')') AS  f_bra_name,
				CONCAT(tmb.`f_ver_name`,'(',tmb.`f_ver_code`,')') AS f_ver_name,
				0 as cigtype
				FROM t_base_materialinfo tbm
				LEFT  JOIN  t_mater_cigbrand tmc   ON tbm.f_cigbrand=tmc.f_data_id
				LEFT  JOIN  t_mater_cigversion tmb  ON  tbm.`f_versioncode`=tmb.`f_data_id`									
		 UNION ALL
		
		 SELECT tbt.f_id, tbt.f_code, tbt.f_name,CONCAT(tmc.f_bra_name,'(',tmc.`f_bra_code`,')') AS  f_bra_name,
				CONCAT(tmb.`f_ver_name`,'(',tmb.`f_ver_code`,')') AS f_ver_name,
				1 as cigtype
				FROM t_base_testcigarette tbt
				LEFT  JOIN  t_mater_cigbrand tmc   ON tbt.f_cigbrand=tmc.f_data_id
				LEFT  JOIN  t_mater_cigversion tmb  ON  tbt.`f_versioncode`=tmb.`f_data_id`	) a
				
									 		
 	<where>
			1=1
	 			<if test="whereCondition!=null">
				<if test="whereCondition.materCode!=null and whereCondition.materCode!=''">
				AND (a.f_mater_code like concat(concat('%',#{whereCondition.materCode,jdbcType=VARCHAR}),'%')  
				or a.f_mater_name like   concat(concat('%',#{whereCondition.materCode,jdbcType=VARCHAR}),'%'))
				</if>			  	
				<if test="whereCondition.cigtype!=null and whereCondition.cigtype!=''">AND a.cigtype = #{whereCondition.cigtype,jdbcType=INTEGER}</if>
				<if test="whereCondition.mainorderId!=null and whereCondition.mainorderId!=''">				
				AND a.f_mater_code not in (SELECT twe.f_mater_code FROM t_ware_entryorderdetail twe 
				WHERE twe.f_mainorder_id = #{whereCondition.mainorderId,jdbcType=INTEGER} )				
				</if>								
			</if>				
		</where>
	
	
	</select>
	
	<select id="queryPageLocal" parameterType="com.ms.warehouse.common.vo.ListVo.ListReqVO"
			resultMap="LocalResultMap">
								
				SELECT
					tbl.f_id,tbl.f_local_code, tbl.f_local_rfid, tbl.f_descript
				FROM
					t_base_locationinfo tbl					
		    <where>			
		  	tbl.f_status = 0
			<if test="whereCondition!=null">
				<if test="whereCondition.localCode!=null and whereCondition.localCode!=''">AND tbl.f_local_code = #{whereCondition.localCode,jdbcType=VARCHAR}</if>				
				<if test="whereCondition.floorCode!=null and whereCondition.floorCode!=''">
					AND tbl.f_area_id in 
 					(SELECT tba.f_id from t_base_areainfo tba WHERE tba.f_floor_id in 
 					(SELECT tbf.f_id from t_base_floorinfo tbf WHERE tbf.f_floor_code = #{whereCondition.floorCode,jdbcType=VARCHAR}))																				
				</if>				
			</if>
 					
			</where>						
		<choose>
			<when test="orderField==null">
				ORDER BY f_id ASC
			</when>
			<otherwise>
				ORDER BY ${orderField}
			</otherwise>
		</choose>
	</select>
	
		<!-- 按ID查询记录 -->
	<select id="queryByOrderDetailId" parameterType="long" resultMap="localResultMap">
		SELECT <include refid="BaseColumnList" />
		FROM t_ware_entrytraylocalmap 
		WHERE f_orderdetail_id  = #{id}	
	</select>
		
	<!-- 更新记录货位状态 -->
	<update id="updateLocal" parameterType="java.util.HashMap">
		UPDATE t_base_locationinfo
		  set f_status = #{status}
		  where
			f_id  = #{localId}
	</update>
		
	<!-- 查询记录数 -->
	<select id="queryDetailedBind" resultType="int"
			parameterType="java.lang.Integer">		
			SELECT COUNT(1) FROM t_ware_entrytraylocalmap twl 
			WHERE twl.f_orderdetail_id =  #{id}				
	</select>
		
	<select id="queryVerByCode" resultType="java.util.HashMap"
			parameterType="String">		
			SELECT tbs.f_id as id ,tbs.f_subver_name as  subverName FROM t_base_subversion tbs WHERE 
			tbs.f_id in (SELECT tbm.f_subver_id from t_base_matersubvermap tbm WHERE tbm.f_mater_code = #{materCode} )
	</select>
	
	<select id="queryDetailed" resultType="java.util.HashMap"
			parameterType="long">		
			SELECT twe.f_id as id FROM  t_ware_entryorderdetail twe WHERE twe.f_mainorder_id = #{id} 	
	</select>
	
	<select id="queryEntryCounts" resultType="java.util.HashMap" parameterType="String">
			SELECT concat(ted.f_mater_name,CONCAT('/',ted.f_subver_name)) as name ,SUM(ted.f_actual_quality) as value			
			,ted.f_mater_code  as materCode ,ted.f_mater_name as materName, 
 			ted.f_mater_version as materVersion,
			ted.f_mater_cigbrand as materCigbrand,	ted.f_subver_name	as subverName
			FROM t_ware_entryorderdetail ted 
			WHERE ted.f_mainorder_id in 
			(SELECT twe.f_id FROM t_ware_entrymainorder twe WHERE twe.f_entry_complite_date  like concat(concat('%',#{_parameter}),'%') )
			GROUP BY ted.f_mater_code, ted.f_subver_id
	</select>		
		
	<select id="queryEntrysStatistics" parameterType="com.ms.warehouse.common.vo.ListVo.ListReqVO"
			resultMap="EntryorderdetailResultMap">
			
			SELECT concat(ted.f_mater_name,CONCAT('/',ted.f_subver_name)) as name ,SUM(ted.f_actual_quality) as value			
			,ted.f_mater_code  as materCode ,ted.f_mater_name as materName, 
 			ted.f_mater_version as materVersion,
			ted.f_mater_cigbrand as materCigbrand,	ted.f_subver_name	as subverName
			FROM t_ware_entryorderdetail ted 
							
			<where>			
			<if test="whereCondition!=null">
				<if test="whereCondition.statisticaltime!=null and whereCondition.statisticaltime!=''">
						ted.f_mainorder_id in 
						(SELECT twe.f_id FROM t_ware_entrymainorder twe WHERE twe.f_entry_complite_date  like concat(concat('%',#{whereCondition.statisticaltime,jdbcType=VARCHAR}),'%') )
						GROUP BY ted.f_mater_code, ted.f_subver_id				
				</if>											
			</if> 					
			</where>
											
		<choose>
			<when test="orderField==null">
				ORDER BY f_id ASC
			</when>
			<otherwise>
				ORDER BY ${orderField}
			</otherwise>
		</choose>
	</select>
	
</mapper>

